<!--
The Template is divided into sections.
Sections get turned off based on which Card Type is displayed.
-->
<div id="card-back">
    <div id="typos" style="display: none">
    </div>
    <!-- Correct Answers Section -->
    <!--For: Radical, Kanji, Vocabulary-->
    <div>
        <br>
        <div class="heading">
            Correct Answers
        </div>
        <p id="correct"></p>
    </div>
    <!--Radical Combination Section-->
    <!--For: Kanji-->
    <div id="section-radical-combination">
        <div class="heading">
            Radical Combination
        </div>
        <div id="combination"></div>
    </div>
    <!--Meaning Section-->
    <!--For: Radical, Kanji, Vocabulary-->
    <div id="section-meaning">
        <details>
            <summary id="meaning-title" class="heading"></summary>
            <p id="meanings"></p>
            <p class="explanation">Explanation</p>
            <div class="mnemonic">
                {{Meaning_Mnemonic}}
            </div>
            <div id="meaning-hint">
                <div class="mnemonic-hint">
                    <p class="hint">
                        <img src="_hint.png" width="12" height="12" alt="">
                        <b style="vertical-align: top">HINTS</b><br>
                    </p>
                    {{Meaning_Hint}}
                </div>
            </div>
        </details>
    </div>
    <!--Reading Section-->
    <!--For: Kanji, Vocabulary-->
    <div id="section-reading">
        <details id="section-reading-details">
            <summary class="heading">
                Reading
            </summary>
            <div id="vocabulary-reading" lang="ja">
                {{Reading}}
            </div>
            <div id="kanji-readings" lang="ja">
                <div id="reading-container">
                    <div id="onyomi-readings">
                        On’yomi<br>
                        {{Reading_Onyomi}}
                    </div>
                    <div id="kunyomi-readings">
                        Kun’yomi<br>
                        {{Reading_Kunyomi}}
                    </div>
                    <div id="nanori-readings">
                        Nanori<br>
                        {{Reading_Nanori}}
                    </div>
                </div>
            </div>
            <div id="reading-audios">
                {{Audio}}
            </div>
{{#Reading_Mnemonic}}
            <p class="explanation">Explanation</p>
{{/Reading_Mnemonic}}
            <div class="mnemonic">
                {{Reading_Mnemonic}}
            </div>
            <div id="reading-hint">
                <div class="mnemonic-hint">
                    <p class="hint">
                        <img src="_hint.png" width="9" height="9" alt="">
                        <b>HINTS</b><br>
                    </p>
                    {{Reading_Hint}}
                </div>
            </div><br>
        </details>
    </div>
    <!--Phonetic-Semantic Composition Section-->
    <!--For: Radical, Kanji-->
    <div id="section-phonetic-semantic">
        <details id="section-phonetic-details">
            <summary class="heading">
                Phonetic-Semantic Composition
            </summary>
            <p class="explanation" id="phonetic-semantic-description"></p>
            <div id="phonetic-semantic-container">
                <div id="phonetic-container"></div>
                <div id="compound-container"></div>
            </div>
        </details>
    </div>
    <!--Context Section-->
    <!--For: Vocabulary-->
    <div id="section-context">
        <details>
            <summary class="heading">
                Context
            </summary>
            <div id="context-patterns">
                <div id="patterns-of-use">
                    <p class="explanation">Patterns of Use</p>
                </div>
                <div id="common-word-combinations">
                    <p class="explanation">Common Word Combinations</p>
                </div>
            </div>
            <p class="explanation">Context Sentences</p>
            <div id="context-sentences"></div>
        </details>
    </div>
    <!--Box Section-->
    <!--For: Radical, Kanji, Vocabulary-->
    <div id="section-box">
        <details>
            <summary id="box-title" class="heading"></summary>
            <div id="box-container"></div>
        </details>
    </div>
    <!--Found in Vocabulary Section-->
    <!--For: Kanji-->
    <div id="section-found-in-vocabulary">
        <details>
            <summary class="heading">
                Found in Vocabulary
            </summary>
            <div id="found-in-vocabulary-container"></div>
        </details>
    </div>
</div><!-- id=card-back -->

__CARD_DATA__

<script type="module">
/* globals _ */
import { chunked, escapeHTML, frag, likelyTypo, stripHTML, zip, $, $$ } from "./_wk3_util.js";
import wanakana from "./_wanakana.min.js";

function setLangJa(elem) {
    elem.setAttribute("lang", "ja");
}

/* SCRIPT: Slice meanings and insert into the Meaning Section. */
let title = "Meaning";
if (_.Card_Type === "Radical") {
    title = "Name";
}

/* SCRIPT: Slice meanings and insert into the Meaning Section. */
$(`#meaning-title`).append(_.Card_Type === "Radical" ? "Name" : "Meaning");

let [primary, ...alternative] = _.Meaning.split(",");

{
    let div = $("#meanings");
    div.insertAdjacentHTML("beforeend", `<p><b>Primary</b> ${primary}</p>`)

    if (alternative.length) {
        div.insertAdjacentHTML("beforeend", `<p><b>Alternative</b> ${alternative}</p>`);
    }

    if (_.Word_Type.length) {
        div.insertAdjacentHTML("beforeend", `<p><b>Word Type</b> ${_.Word_Type}</p>`);
    }
}

/* SCRIPT: Disable unused Reading divisions. */
function maybe_hide_elem(id, readings) {
    let div = document.getElementById(id);
    div.style.display = readings ? "" : "none";
}

maybe_hide_elem("onyomi-readings", _.Reading_Onyomi);
maybe_hide_elem("kunyomi-readings", _.Reading_Kunyomi);
maybe_hide_elem("nanori-readings", _.Reading_Nanori);

/* SCRIPT: Disable unused Hint divisions. */
maybe_hide_elem("meaning-hint", _.Meaning_Hint);
maybe_hide_elem("reading-hint", _.Reading_Hint);

/* SCRIPT: Slice and add Context Patterns  */
let combinations = _.Context_Patterns.split("|");

function addCombinations(idx) {
    let div = $("#common-word-combinations");
    for (let [ja, en] of chunked(combinations[idx].split(";"), 2)) {
        let element = document.createElement("p");
        element.innerHTML = `<ja lang="ja">${ja}</ja><br>${en}`;
        element.classList.add("combination");
        div.appendChild(element);
    }
}
addCombinations(0);

for (let [i, val] of combinations.entries()){
    let element = document.createElement("div");
    element.innerHTML = `
        <button class="button" lang="ja" name="${i}" onclick="onButtonClick(event)">${
            val.split(";")[0]
        }</button><br>`;
    $("#patterns-of-use").appendChild(element);
}

$(".button[name='0']").classList.add("clicked");

window.onButtonClick = function onButtonClick(event) {
    for (let elem of $$(".button")){
        elem.classList.remove("clicked");
    }
    event.target.classList.add("clicked");

    for (let elem of $$(".combination")) {
        elem.remove();
    }
    addCombinations(event.target.name);
}
if (combinations.length === 0) {
    $("#context-patterns").textContent = " ";
}

/* SCRIPT: Slice and add context sentences. */
if (["Vocabulary", "Kana Vocabulary"].includes(_.Card_Type)) {
    let div = $("#context-sentences");

    for (let [en, jp] of chunked(_.Context_Sentences.split("|"), 2)) {
        let element = document.createElement("p");
        element.innerHTML = `<ja>${jp}</ja><br>${en}`;
        div.appendChild(element);
    }
}

/* SCRIPT: Disable divisions. */
switch (_.Card_Type) {
    case "Radical":
        $("#section-reading").style.display = "none";
        $("#section-context").style.display = "none";
        $("#section-radical-combination").style.display = "none";
        $("#section-found-in-vocabulary").style.display = "none";
        break;
    case "Kanji":
        $("#section-context").style.display = "none";
        break;
    case "Vocabulary":
    case "Kana Vocabulary":
        $("#section-radical-combination").style.display = "none";
        $("#section-found-in-vocabulary").style.display = "none";
}

/* SCRIPT: Populate Box Characters (Found in Kanji, Visually Similar Kanji and Kanji Composition). */
switch (_.Card_Type) {
  case "Radical": {
    let found_in = zip(
       _.Found_in_Characters.split("、 "),
       _.Found_in_Reading.split("、 "),
       _.Found_in_Meaning.split("、 ")
    );
    if (found_in.length !== 0) {
        $("#box-title").textContent = "Found In Kanji";

        for (let [char, reading, meaning] of found_in) {
            $("#box-container").appendChild(frag(
                `<div id="box-character" lang="ja">
                    ${char}
                    <div id="box-meaning">
                        ${reading}<br>
                        ${meaning}
                    </div>
                </div>`));
        }
    } else {
        $("#section-box").remove();
    }
    break;
  }
  case "Kanji": {
    let similar = zip(
       _.Similar_Characters.split("、 "),
       _.Similar_Reading.split("、 "),
       _.Similar_Meaning.split("、 ")
    );

    if (similar.length !== 0) {
        $("#box-title").textContent = "Visually Similar Kanji";

        for (let [char, reading, meaning] of similar) {
            $("#box-container").appendChild(frag(
                `<div id="box-character" lang="ja">
                    ${char}
                    <div id="box-meaning">
                        ${reading}<br>
                        ${meaning.substring(0, 15)}
                    </div>
                </div>`));
        }
    } else {
        $("#section-box").remove();
    }
    break;
  }
  case "Vocabulary":
  case "Kana Vocabulary": {
    let comps = zip(
       _.Components_Characters.split("、 "),
       _.Components_Reading.split("、 "),
       _.Components_Meaning.split("、 ")
    );

    if (comps.length !== 0) {
        $("#box-title").textContent = "Kanji Composition";

        for (let [char, reading, meaning] of comps) {
            $("#box-container").appendChild(frag(
                `<div id="box-character">
                    ${char}
                    <div id="box-meaning">
                        ${reading}<br>
                        ${meaning.substring(0, 15)}
                    </div>
                </div>`));
        }
    } else {
        $("#section-box").remove();
    }
    break;
  }
  default:
    $("#section-box").remove();
}

/* SCRIPT: Add Phonetic-Semantic Composition Characters. */
switch (_.Card_Type) {
  case "Kanji":
  case "Radical": {
    let sectionarray = _.Keisei.split(" | ");
    let start = 1;
    let data = sectionarray[0].split(", ");
    let description = $("#phonetic-semantic-description");
    if (data[0] == "compound" || data[0] == "phonetic") {
        if (data[0] == "compound") {
            description.innerHTML = `
                The kanji <kanji>{{Characters}}</kanji> was created using
                semantic-phonetic composition.<br>
                <br>
                The phonetic component is 「<ja>${data[2]}</ja>」with the ON
                reading(s) 「<ja>${data[3]}</ja>」
                (including rare ones), and the semantic component is
                「<ja>${data[4]}</ja>」.<br>`;
        } else if (data[0] == "phonetic") {
            if (_.Card_Type === "Kanji") {
                description.innerHTML = `
                    The kanji <kanji>{{Characters}}</kanji> is used as a phonetic
                    component in other compounds.<br>
                    Its ON reading(s) are 「<ja>${data[3]}</ja>」.<br>`;
            } else {
                description.innerHTML = `
                    The radical <radical>{{Characters}}</radical> is used as a phonetic
                    component in other compounds.<br>
                    Its ON reading(s) are 「<ja>${data[3]}</ja>」.<br>`;
            }
        }

        {
            let div = $("#phonetic-container");
            div.appendChild(frag(
                `<div id="phonetic-character" lang="ja">
                    ${data[2]}
                    <div id="box-meaning">
                        ${data[3].split("・")[0]}<br>
                        Phonetic
                    </div>
                </div>`));
            if (data[1].includes("R")) {
                div.appendChild(frag(
                    `<div id="radical-character" lang="ja">
                        ${data[2]}
                        <div id="box-meaning">
                            ${data[3].split("・")[0]}<br>
                            ${sectionarray[start]}
                        </div>
                    </div>`));
                start += 1;
            }
            if (data[1].includes("K")) {
                div.appendChild(frag(
                    `<div id="box-character">
                        ${data[2]}
                        <div id="box-meaning">
                            ${sectionarray[start].split(", ")[1]}<br>
                            ${sectionarray[start].split(", ")[0]}
                        </div>
                    </div>`));
                start += 1;
            }
        }
        let div = $("#compound-container");
        for (let section of sectionarray) {
            let parts = section.split(", ");
            div.appendChild(frag(
                `<div id="box-character">
                    ${parts[0]}
                    <div id="box-meaning">
                        ${parts[1]}<br>
                        ${parts[2]}
                    </div>
                </div>`));
        }
    } else if (data[0] == "unprocessed") {
        description.innerHTML = `
            The kanji <kanji>{{Characters}}</kanji> has not been added to the WK
            Userscripts Keisei DB yet.
            Please wait for a future version.<br>`;
    } else if (data[0] == "nonradical") {
        description.innerHTML = `
            The radical <radical>{{Characters}}</radical> is not considered a
            phonetic mark.<br>`;
    } else if (data[0] == "unknown") {
        description.innerHTML = `
            The kanji <kanji>{{Characters}}</kanji> has an unknown or contested origin,
            or its phonetic mark is too obscure to be useful.
            Stay tuned for more information in future versions of WK Userscripts
            Keisei.`;
    } else if (_.Keisei != "") {
        description.innerHTML = `
            The kanji <kanji>{{Characters}}</kanji> is not considered a
            semantic-phonetic composition.<br>
            Note: {{Keisei}}<br>`;
    } else {
        $("#section-phonetic-semantic").style.display = "none";
    }
    break;
  }
  default:
    $("#section-phonetic-semantic").style.display = "none";
}

/* SCRIPT: Add Radical Combination Characters. */
let comps = zip(
   _.Components_Characters.split("、 "),
   _.Components_Meaning.split("、 ")
)

for (let [i, [char, meaning]] of comps.entries()) {
    {
        let element = document.createElement("div");
        element.style.display = "flex";
        element.style.alignItems = "center";

        element.innerHTML = `
            <radical-combination lang="ja">
                <div>${char}</div>
            </radical-combination>
            <div>
                ${meaning.substring(0, 15)}
            </div>`;
        $("#combination").appendChild(element);
    }

    if (i + 1 != comps.length) {
        $("#combination").appendChild(frag(
            "<p><div class=combination-plus><b>+<b/></div></p>"));
    }
}

/* SCRIPT: Add Found in Vocabulary Characters. */
let found_in = zip(
    _.Found_in_Characters.split("、 "),
    _.Found_in_Reading.split("、 "),
    _.Found_in_Meaning.split("、 ")
)

for (let [char, reading, meaning] of found_in) {
    $("#found-in-vocabulary-container").appendChild(frag(
        `<div id="found-in-vocabulary-box">
            <div class="found-in-voc" lang="ja">
                ${char}
            </div>
            <div class="found-in-voc-reading" lang="ja">
                ${reading}<br>
                ${meaning}
            </div>
        </div>`));
}

if (found_in.length == 0) {
    $("#section-found-in-vocabulary").style.display = "none";
}

/* SCRIPT: Check the answer  */
let mangleAnswer = ans => ans.toLowerCase().replace("'", "");

let typeans = $("#typeans");
if (typeans) {
    var typedAnswer = "";
    typeans.innerHTML = typeans.innerHTML.replace(/<br.*/, "");
    typeans.querySelectorAll(".typeGood, .typeBad").forEach((e) => {
        if (e.innerText == "-") return;
        typedAnswer += e.innerText;
    });
    var typedAnswerLower = mangleAnswer(typedAnswer);
} else {
    typedAnswerLower = "";
}

let meaningWhitelist = new Set(_.Meaning_Whitelist.toLowerCase().split(", "));
let readingWhitelist = new Set(_.Reading_Whitelist.toLowerCase().split(", "));
let correctAnswers = [];
let correctText = $("#correct");

switch (_.Card) {
  case "Meaning": {
    let capitalize = iter => Array.from(iter, elem =>
        elem.replace(/(^| )\w/g, c => c.toUpperCase()));

    correctAnswers = new Set(_.Meaning.toLowerCase().split(", "));
    let [meaning, ...alternatives] = capitalize(correctAnswers);

    let accepted = meaningWhitelist.difference(correctAnswers);
    correctAnswers = correctAnswers.union(accepted);

    correctText.innerHTML = `Primary: <b>${meaning}</b>`;
    if (alternatives.length) {
        correctText.insertAdjacentHTML("beforeend", `<br>
            Alternative: <b>${alternatives.join(", ")}</b>`);
    }
    if (accepted.size) {
        correctText.insertAdjacentHTML("beforeend", `<br>
            <details>
                <summary>Accepted:</summary>
                <b>${capitalize(accepted).join(", ")}</b>
            </details>`);
    }
    $("#section-meaning").firstElementChild.open = true;
    break;
  }
  case "Reading": {
    correctAnswers = readingWhitelist;
    let items = Array.from(correctAnswers, x => `<reading>${x}</reading>`);
    correctText.innerHTML = items.join(" ");

    $("#section-phonetic-semantic").after($("#section-meaning"));
    $("#section-reading").firstElementChild.open = true;
  }
}

function checkTypos(answers, expected, mangle = x => x) {
    let found = 0;
    let typos = $("#typos");
    for (let ans of answers) {
        for (let exp of expected) {
            if (likelyTypo(mangle(exp), mangle(ans))) {
                found++;
                typos.insertAdjacentHTML("beforeend", `
                    <div class="typo">
                        Did you mean <span class="typo-expected">${escapeHTML(exp)}</span>
                        instead of <span class="typo-ans">${escapeHTML(ans)}</span>?
                    </div>
                `)
            }
        }
    }
    if (found) {
        typos.style.display = "";
    }
}

if (typedAnswerLower !== "") {
    let answerDiv = document.createElement("div");
    answerDiv.setAttribute("id", "typeans");
    answerDiv.textContent = typedAnswer;
    answerDiv.classList.add("typeans-{{Card}}")
    if (_.Card == "Reading") {
        setLangJa(answerDiv);
    }
    $("#typeans").replaceWith(answerDiv);

    correctAnswers = new Set(
        Array.from(correctAnswers, a => mangleAnswer(stripHTML(a))));

    let answers = new Set(typedAnswerLower.split(/[、,]\s*/));
    if (answers.isSubsetOf(correctAnswers)) {
        answerDiv.classList.add("correct");
    } else {
        answerDiv.classList.add("incorrect");

        let mangle = _.Card_Type == "Reading" ? wanakana.toRomaji : x => x;
        checkTypos(answers, correctAnswers, mangle);
    }
} else {
    $("#input").style.display = "none";
}

/*  Generate tooltips  */
function setTooltips(sel, text, isJa = false) {
    for (let tag of $$(sel)) {
        tag.setAttribute("title", text);
        if (isJa) {
            setLangJa(tag);
        }
    }
}

for (let tag of $$("ja")) {
    setLangJa(tag)
}

setTooltips("kanji", "Kanji", true);
setTooltips("radical", "Radical", true);
setTooltips("vocabulary", "Vocabulary", true);
setTooltips("reading", "Reading", true);
</script>
